<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Upload Meeting</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f6f8;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100vh;
    }
    h2 { color: #333; margin-bottom: 20px; }

    input, button {
      margin: 10px;
      padding: 10px;
      font-size: 16px;
      border-radius: 6px;
    }

    button {
      border: none;
      cursor: pointer;
      color: white;
      background-color: #007bff;
    }
    button:hover { background-color: #0069d9; }

    #backBtn {
      background-color: #6c757d;
    }
    #backBtn:hover { background-color: #5a6268; }

    #status {
      margin-top: 15px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h2>Upload Meeting (Chunked)</h2>

  <input type="text" id="username" placeholder="Username" />
  <input type="text" id="meetingName" placeholder="Meeting Name" />
  <input type="file" id="audioFile" accept=".wav,.mp3" />
  <button id="uploadBtn">Upload</button>
  <button id="backBtn">Back to Home</button>

  <p id="status"></p>

  <script>
    const uploadBtn = document.getElementById("uploadBtn");
    const backBtn = document.getElementById("backBtn");
    const statusEl = document.getElementById("status");

    backBtn.addEventListener("click", () => window.location.href = "/");

    uploadBtn.addEventListener("click", async () => {
      const file = document.getElementById("audioFile").files[0];
      const username = document.getElementById("username").value.trim();
      const meetingName = document.getElementById("meetingName").value.trim();

      if (!file || !username || !meetingName) {
        statusEl.textContent = "Please fill in all fields and select a file.";
        statusEl.style.color = "red";
        return;
      }

      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const arrayBuffer = await file.arrayBuffer();
      const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);

      const chunkDuration = 60; // seconds per chunk
      const totalChunks = Math.ceil(audioBuffer.duration / chunkDuration);
      statusEl.textContent = `Processing ${totalChunks} chunks...`;
      statusEl.style.color = "black";

      for (let i = 0; i < totalChunks; i++) {
        const start = i * chunkDuration;
        const end = Math.min((i + 1) * chunkDuration, audioBuffer.duration);

        // Slice the audio buffer for this chunk
        const chunkBuffer = audioContext.createBuffer(
          audioBuffer.numberOfChannels,
          (end - start) * audioBuffer.sampleRate,
          audioBuffer.sampleRate
        );

        for (let channel = 0; channel < audioBuffer.numberOfChannels; channel++) {
          const channelData = audioBuffer.getChannelData(channel).slice(
            start * audioBuffer.sampleRate,
            end * audioBuffer.sampleRate
          );
          chunkBuffer.copyToChannel(channelData, channel);
        }

        // Convert chunk to WAV blob
        const wavBlob = bufferToWav(chunkBuffer);

        // Send to backend
        const formData = new FormData();
        formData.append("file", wavBlob, `chunk_${i + 1}.wav`);
        formData.append("username", username);
        formData.append("meetingName", meetingName);
        formData.append("chunkNumber", i + 1);
        formData.append("totalChunks", totalChunks);

        await fetch("/upload", {
          method: "POST",
          body: formData
        });

        statusEl.textContent = `Uploaded chunk ${i + 1}/${totalChunks}...`;
      }

      statusEl.style.color = "green";
      statusEl.textContent = "All chunks uploaded successfully!";
    });

    // Helper: convert AudioBuffer â†’ WAV Blob
    function bufferToWav(buffer) {
      const numOfChan = buffer.numberOfChannels;
      const length = buffer.length * numOfChan * 2 + 44;
      const bufferView = new ArrayBuffer(length);
      const view = new DataView(bufferView);
      const channels = [];
      let offset = 0;
      let pos = 0;

      // Write WAV header
      setUint32(0x46464952); // "RIFF"
      setUint32(length - 8);
      setUint32(0x45564157); // "WAVE"

      setUint32(0x20746d66); // "fmt " chunk
      setUint32(16);
      setUint16(1);
      setUint16(numOfChan);
      setUint32(buffer.sampleRate);
      setUint32(buffer.sampleRate * 2 * numOfChan);
      setUint16(numOfChan * 2);
      setUint16(16);

      setUint32(0x61746164); // "data"
      setUint32(length - pos - 4);

      // Write interleaved data
      for (let i = 0; i < numOfChan; i++) channels.push(buffer.getChannelData(i));
      while (pos < length) {
        for (let i = 0; i < numOfChan; i++) {
          const sample = Math.max(-1, Math.min(1, channels[i][offset] || 0));
          view.setInt16(pos, sample < 0 ? sample * 0x8000 : sample * 0x7FFF, true);
          pos += 2;
        }
        offset++;
      }

      return new Blob([bufferView], { type: "audio/wav" });

      function setUint16(data) { view.setUint16(pos, data, true); pos += 2; }
      function setUint32(data) { view.setUint32(pos, data, true); pos += 4; }
    }
  </script>
</body>
</html>
